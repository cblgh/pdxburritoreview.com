<!-- vim: set ts=4 sw=4 noet : -->
<!DOCTYPE html>
<html>
	<head>
		<title>PDX Burrito Review - xXx TITLE xXx</title>
		<meta name="description" content="Portland Burrito Reviews">
		<meta http-equiv="content-type" content="text/html;charset=UTF-8">
		<link type="text/css" rel="stylesheet" href="/static/css/main.css" >

		xXx INCLUDES xXx
	</head>
	<body>
		<div id="app">
			<header>
				<div class="header">
					<div class="header_img"></div>
					<p v-if="loading">Loading...</p>
					<div v-if="!loading">
						<p>Eat burritos die young</p>
						<div v-for="ngh in neighborhoods">
							<p>{{ngh[1]}}</p>
							<ul>
								<li is="BurritoStoreLI"
									v-bind:value="value"
									v-bind:map="map"
									v-for="(value, key) in reviews[ngh[0]]"
									:key="value.uuid">
								</li>
							</ul>
						</div>
					</div>
				</div>
				<div class="copyright">
					<p>Burrito by Denis Sazhin from the Noun Project</p>
					<p>© Copyright 2019 <a href="http://q.pfiffer.org/">Quinlan Pfiffer</a></p>
				</div>
			</header>
		</div>
		<div id="map"></div>
		<ReviewPane v-bind:shouldShowReviewPane="shouldShowReviewPane"></ReviewPane>
	</body>
	<script type="text/javascript">
		Vue.component('ReviewPane', {
			props: ['shouldShowReviewPane'],
			methods: {
				showReviewPaneF: function() {
					console.log("Called showReviewPaneF");
					this.shouldShowReviewPane = true;
				},
			},
			data: function() {
				return {
				}
			},
			template:
				`<div v-if="!shouldShowReviewPane" v-on:show-review-pane="showReviewPaneF" class="review_pane">
					<h3>Name of place</h3>
				<div>`
		});
		Vue.component('BurritoStoreLI', {
			props: ['map', 'value'],
			data: function() {
				return {
					isActive: false,
				}
			},
			methods: {
				setActive: function(val) { if (val === false) { console.log("DEACTIVATED"); } this.isActive = val; },
				onClick: function(e) {
					e.preventDefault();
					const self = this;
					const latLngs = [ self.value.mapMarker.getLatLng() ];
					const markerBounds = L.latLngBounds(latLngs);
					self.map.fitBounds(markerBounds);
					self.$emit('show-review-pane');
					self.$emit('deactivate');
					self.setActive(true);
				}
			},
			template: '<li v-on:deactivate="setActive(false)" class="location"><a v-bind:class="{active: isActive}" v-on:click="onClick" href="#">{{value.name}}</a> </li>'
		});
		const app = new Vue({
			el: "#app",
			data: {
				loading: true,
				neighborhoods: [
					['NW', 'Northwest'],
					['NE', 'Northeast'],
					['SE', 'Southeast'],
					['SW', 'Southwest'],
					['Downtown', 'Downtown'],
				],
				shouldShowReviewPane: false,
				reviews: [],
				map: null,
				selectedUUID: null
			},
			methods: {
				addPoints: function() {
					const self = this;
					for (const key in self.reviews) {
						const region = self.reviews[key];
						for (let store of region) {
							if (store.lat && store.lng)
								store.mapMarker = L.marker([store.lat, store.lng]).addTo(self.map);
						}
					}
				},
				load: function() {
					const self = this;
					fetch("/data/reviews.json").then(function(data) {
						data.text().then(function(asText) {
							const parsedData = JSON.parse(asText);
							self.reviews = parsedData;
							self.loading = false;
							// Probably a race condition here waiting on map load, but whatever.
							self.addPoints();
						})
					});
				},
				buildMap: function() {
					const self = this;
					self.map = L.map('map').setView([45.5155, -122.6793], 13);
					L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
						attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
						maxZoom: 18,
						id: 'mapbox.streets',
						accessToken: 'pk.eyJ1IjoicXBmaWZmZXIiLCJhIjoiY2p4bWdobmphMDNvOTNicWhmbm9jaXJhNSJ9.W5lmNhX-Fdl1ejdoIhVmDg'
					}).addTo(self.map);
				}
			},
			created: function() {
				this.load();
				this.buildMap();
			}
		});
	</script>
</html>
